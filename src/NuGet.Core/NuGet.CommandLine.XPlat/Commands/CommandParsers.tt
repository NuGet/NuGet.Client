<#@ template debug="false" hostspecific="true" language="C#" #>
<#@ assembly name="System.Xml.XDocument" #>
<#@ assembly name="System.Xml.Linq" #>
<#@ assembly name="System.Xml" #>
<#@ assembly name="System.Core" #>
<#@ import namespace="System.Xml.Linq" #>
<#@ import namespace="System.Linq" #>
<#@ output extension=".cs" #>
<#
    string InitCaps(string input)
    {
        string output = input.Substring(0,1).ToUpper() + input.Substring(1);
        return output;
    }

    bool IsArgument(string type)
    {
        return type == "Argument";
    }

    string GetProperty(XElement element)
    {
        switch  (element.Name.LocalName)
        {
            case "SingleValueOption":
                return "Option";
            case "SwitchOption":
                return "Option";
            case "Argument":
                return "Argument";
            default:
                return "Unknown Element Type" + element.Name.LocalName;
        }
    }

    string GetOptionType(XElement element)
    {
        switch (element.Name.LocalName)
        {
            case "SingleValueOption":
                return "SingleValue";
            case "SwitchOption":
                return "NoValue";
            case "Value":
                return "Value";
            default:
                return "Unknown Element Type" + element.Name.LocalName;
        }
    }

    var commandFile = this.Host.ResolvePath("Commands.xml");
    var commands = XDocument.Load(commandFile);
#>
// Copyright (c) .NET Foundation. All rights reserved.
// Licensed under the Apache License, Version 2.0. See License.txt in the project root for license information.

// Do not manually edit this autogenerated file:
// instead modify the neighboring .tt file (text template) and/or NuGet.CommandLine.Xplat\Commands\Commands.xml (data file),
// then re-execute the text template via "run custom tool" on VS context menu for .tt file, or via dotnet-t4 global tool.

using System;
using Microsoft.Extensions.CommandLineUtils;
using NuGet.Common;

namespace NuGet.CommandLine.XPlat
{
    internal static class CommandParsers
    {
        public static void Register(CommandLineApplication app, Func<ILogger> getLogger)
        {
<#
 foreach (var command in commands.Descendants(XName.Get("Verb","")))
 {
    var verbName = command.Attribute(XName.Get("Name", "")).Value;
    var verbFormalName = InitCaps(verbName);
#>
            <#= verbFormalName #>VerbParser.Register(app, getLogger);
<#
 }
#>
<#
 foreach (var command in commands.Descendants(XName.Get("Command","")))
 {
    var commandName = command.Attribute(XName.Get("Name", "")).Value;
    var commandFormalName = InitCaps(commandName);
#>
            <#= commandFormalName #>CommandParser.Register(app, getLogger);
<#
}
#>        }
    }
<#
 foreach (var command in commands.Descendants(XName.Get("Command","")))
 {
    var commandName = command.Attribute(XName.Get("Name", "")).Value;
    var commandFormalName = InitCaps(commandName);
#>

    internal partial class <#= commandFormalName #>CommandParser
    {
        internal static void Register(CommandLineApplication app, Func<ILogger> getLogger)
        {
            app.Command("<#= commandName #>", <#= commandFormalName #>Cmd =>
            {
<#
        foreach (var option in command.Descendants()) {
            var optionName = option.Attribute(XName.Get("Name", "")).Value;
            var optionHelp = option.Attribute(XName.Get("Help", ""))?.Value;
            var optionFormalName = optionName.Replace("-","");
            var optionCapsName = InitCaps(optionName);
            if (IsArgument(GetProperty(option)))
            {
#>
                var <#= optionFormalName #> = <#= commandFormalName #>Cmd.Argument(
                    "<#= optionName #>", "<#= optionHelp != null ? optionHelp : "" #>");
<#
            }
            else
            {
                var optionShortcut = option.Attribute(XName.Get("Shortcut",""))?.Value;
#>
                var <#= optionFormalName #> = <#= commandFormalName #>Cmd.Option(
                    "<#= (optionShortcut != null ? "-" + optionShortcut + "|" : "") + "--" + optionName #>",
                    Strings.Source_Description,
                    CommandOptionType.<#= GetOptionType(option) #>);
<#
            }
        }
#>
                <#= commandFormalName #>Cmd.HelpOption("-h|--help");

                <#= commandFormalName #>Cmd.OnExecute(() =>
                {
                    var args = new <#= commandFormalName #>FArgs()
                    {
<#
        foreach (var option in command.Descendants()) {
            var optionName = option.Attribute(XName.Get("Name", "")).Value;
            var optionFormalName = optionName.Replace("-","");
            var optionCapsName = InitCaps(optionFormalName);
            if (IsArgument(GetProperty(option)))
            {
#>
                        <#= optionCapsName #> = <#=optionFormalName#>.Value,
<#
            }
            else
            {
                var optionType = GetOptionType(option);
                switch (optionType)
                {
                    case "SingleValue":
#>
                        <#= optionCapsName #> = <#= optionFormalName #>.Value(),
<#                    
                    break;
                    case "NoValue":
#>
                        <#= optionCapsName #> = <#= optionFormalName #>.HasValue(),
<#                    
                    break;
                }
            
            }
        }
    
#>
                    };


<#  // ****** IMPLEMENT REQUIRED ARGUMENTS ********
    

        foreach (var option in command.Descendants()) {
            var optionName = option.Attribute(XName.Get("Name", "")).Value;
            var required = option.Attribute(XName.Get("Required", ""))?.Value == "true";
            var optionFormalName = optionName.Replace("-","");
            var optionCapsName = InitCaps(optionFormalName);

            if (required)
            {
                if (IsArgument(GetProperty(option)))
                {
#>
                    if (args.<#= optionCapsName #> == null)
                    {
                        throw new CommandException("'<#=optionFormalName#>' argument is missing but required.");
                    }
<#
                }
                else
                {
                    var optionType = GetOptionType(option);
                    switch (optionType)
                    {
                        case "SingleValue":
#>
                        if (args.<#= optionCapsName #> == null)
                        {
                            throw new CommandException("'<#=optionFormalName#>' option is missing but required.");
                        }
<#                    
                        break;
                        case "NoValue":
#>
                        //TODO: implement required for bool
<#                    
                        break;
                    }
            
                }
            }
        }
// ****** END - IMPLEMENT REQUIRED ARGUMENTS ********
#> 

                    <#= commandFormalName #>FRunner.Run(args, getLogger);
                    return 0;
                });
            });
        }
    }
<#
} // End of CommandParser class
#>
}
